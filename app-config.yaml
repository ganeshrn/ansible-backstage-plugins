# Ansible RHDH / Self-Service Configuration
# 
# This configuration includes a DYNAMIC RBAC solution for AAP superusers:
# 
# ðŸš€ DYNAMIC RBAC FEATURES:
#   â€¢ AAP superusers automatically get /rbac admin access
#   â€¢ Zero backend restarts needed for user changes  
#   â€¢ Automatic user addition/removal based on is_superuser status
#   â€¢ Group-based assignment via aap-admins group
#
# ðŸ”„ HOW IT WORKS:
#   1. AAPEntityProvider syncs AAP users every 60 minutes
#   2. Creates dynamic 'aap-admins' group with current superusers
#   3. RBAC grants admin permissions to group members
#   4. New superusers get access automatically on next sync
#   5. Former superusers lose access automatically on next sync
#

app:
  title: Ansible RHDH / Self-Service
  baseUrl: http://localhost:3000
organization:
  name: Ansible RHDH
backend:
  auth:
    keys:
      - secret: ${BACKEND_SECRET:-development-secret-change-in-production}
    sessions:
      # Persistent signing key prevents JWT token invalidation on backend restarts
      # This is essential for dynamic RBAC automation and service-to-service authentication
      signingKey: ${AUTH_SIGNING_KEY:-myPersistentSigningKey123456789012345678901234567890}
  baseUrl: http://localhost:7007
  listen:
    port: 7007
  csp:
    connect-src:
      - '''self'''
      - 'http:'
      - 'https:'
  cors:
    origin: http://localhost:3000
    methods:
      - GET
      - HEAD
      - PATCH
      - POST
      - PUT
      - DELETE
    credentials: true
  database:
    client: better-sqlite3
    connection: ':memory:'
  # workingDirectory: /tmp # Use this to configure a working directory for the scaffolder, defaults to the OS temp-dir
  reading:
    allow:
      - host: gitlab.com
      - host: github.com
      - host: raw.githubusercontent.com
      - host: localhost
  request:
    bodyParsing:
      sizeLimit: 10mb
integrations:
  github:
    - host: github.com
      token: <YOUR_GITHUB_PAT>
  gitlab:
    - host: gitlab.com
      token: <YOUR_GITLAB_PAT>
proxy: null
techdocs:
  builder: local
  generator:
    runIn: docker
  publisher:
    type: local
enableExperimentalRedirectFlow: true
signInPage: rhaap
auth:
  # Omit group memberships from JWT tokens to prevent token size issues
  # Group memberships will be fetched via /v1/userinfo endpoint instead
  omitIdentityTokenOwnershipClaim: true
  environment: development
  providers:
    github:
      development:
        clientId: <changeme>
        clientSecret: <changeme>
    rhaap:
      development:
        host: <changeme>
        checkSSL: false
        clientId: <changeme>
        clientSecret: <changeme>
        signIn:
          resolvers:
            - resolver: allowNewAAPUserSignIn
scaffolder: null
catalog:
  stitchingStrategy:
    immediate: true
  orphanStrategy: delete
  processingInterval:
    seconds: 10
  pollingInterval:
    seconds: 1
  stitchTimeout:
    minutes: 1
  import:
    entityFilename: catalog-info.yaml
    pullRequestBranchName: backstage-integration
  rules:
    - allow:
        - Component
        - System
        - Group
        - Resource
        - Location
        - Template
        - API
        - Users
  # Note: No static locations needed - aap-admins group is dynamically managed by AAPEntityProvider
  useUrlReadersSearch: true
  providers:
    rhaap:
      development:
        orgs: SIG-IDE
        sync:
          # Syncs AAP organizations, users, and teams
          # Also creates dynamic aap-admins group with current superusers
          orgsUsersTeams:
            schedule:
              frequency: { minutes: 60 }
              timeout: { minutes: 15 }
          jobTemplates:
            enabled: true
            schedule:
              frequency: { minutes: 60 }
              timeout: { minutes: 15 }
ansible:
  analytics:
    enabled: true
  devSpaces:
    baseUrl: https://devspaces.apps.ansible-rhdh.testing.ansible.com/
  automationHub:
    baseUrl: https://example.com
  rhaap:
    # Ansible Automation Platform connection settings
    baseUrl: <changeme>    # AAP controller URL
    token: <changeme>      # AAP API token with appropriate permissions
    checkSSL: false        # Set to true in production
  creatorService:
    baseUrl: localhost
    port: '8000'
kubernetes: null

permission:
  enabled: true
  rbac:
    # if you want to use a csv file for rbac, uncomment the following lines.
    # Refer default-rbac-policy.csv for the policy file.
    # policies-csv-file: /Users/audgirka/src/ansible-backstage-plugins/default-rbac-policy.csv
    # policyFileReload: true
    admin:
      users:
        - name: user:default/admin              # Bootstrap admin for initial setup
        - name: group:default/aap-admins        # ðŸš€ DYNAMIC RBAC: AAP superusers with full permissions
      superUsers:
        - name: user:default/admin              # Bootstrap admin with full permissions  
        - name: group:default/aap-admins        # ðŸš€ DYNAMIC RBAC: AAP superusers with full permissions
    # Plugins that require permission evaluation
    pluginsWithPermission:
      - catalog
      - scaffolder
      - permission
